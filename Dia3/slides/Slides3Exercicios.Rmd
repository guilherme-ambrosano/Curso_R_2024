---
title: |
  | Manipulação e
  | Apresentação
  | de Dados
author: "Guilherme Bovi Ambrosano"
date: "Dia 3 - Exercícios - 09/08/2024"
output:
    beamer_presentation:
      includes:
        in_header:
          - config/config.sty
      latex_engine: xelatex
      keep_tex: false
      toc: false
fontsize: 10pt
---

```{r setup, include=FALSE}
library(tidyverse)

linhas <- read_lines(
  "http://www.leb.esalq.usp.br/leb/exceldados/DCE2023.TXT")

inicio <- which(str_starts(linhas, "="))[c(1, seq(3, 37, 3))]
final <- which(str_starts(linhas, "="))[c(2, seq(5,37,3), 37)]
pular <- sapply(seq(1,13), function(i){
  seq(inicio[i], final[i])
})
pular2 <- which(linhas=="")

linhas2 <- linhas[-c(unlist(pular),pular2)]

dados_meteorologicos <- as_tibble(linhas2) %>%
  separate(value,
           c("No", "ANO", "DIA", "MES", "R.GLOBA",
             "INSOLACAO", "PRECIPITACAO", "UMIDADE RELATIV",
             "VENTO MAXIMO", "VENTO MEDIO", "TEMPER MAXIMA",
             "TEMPER MINIMA", "TEMPER MEDIA", "EVAPORACAO"),
           sep=" +") %>%
  unite(Data, DIA, MES, ANO) %>%
  mutate(Data=lubridate::dmy(Data)) %>%
  mutate_at(vars(-Data), str_replace, ",", ".") %>%
  mutate_at(vars(-Data), parse_number) %>%
  filter(!is.na(Data))

Sys.setlocale(category = "LC_TIME", locale = "pt_BR.UTF-8")
knitr::opts_chunk$set(echo = FALSE)
```


# -
\section{Exercícios}
\framecard{{\color{white}\Huge{Exercícios}}}

# Exercício 1

Fazer um gráfico como o exemplo a seguir:

```{r, fig.height=6}

cor(attitude) %>%
  as.data.frame() %>% 
  rownames_to_column("Var1") %>%
  pivot_longer(-Var1, names_to="Var2") %>% 
  mutate_at(vars(Var1, Var2), ~factor(., levels=unique(.))) %>% 
  mutate_at(vars(Var1, Var2), fct_relabel, str_to_title) %>% 
  filter(as.numeric(Var1)>as.numeric(Var2)) %>% 
  ggplot(aes(x=Var1, y=Var2, fill=value)) +
  geom_tile(width=.9, height=.9, color="grey25") +
  geom_text(aes(label=round(value, 4))) +
  scale_fill_gradient2(limits=c(-1, 1)) +
  labs(fill="Coeficiente de\ncorrelação de\nPearson") +
  theme_minimal() +
  theme(axis.title = element_blank())

```

# Exercício 2

Personalizar o gráfico a seguir:

```{r, echo=T, eval=F}

dados_meteorologicos %>%
  select(Data, PRECIPITACAO, starts_with("TEMPER")) %>%
  pivot_longer(starts_with("TEMPER")) %>%
  ggplot(aes(x=Data)) +
  geom_bar(stat="unique", aes(y=PRECIPITACAO)) +
  geom_line(aes(y=value, color=name))
  
```
Exemplo:

```{r, fig.height=3}

dados_meteorologicos %>%
  select(Data, PRECIPITACAO, starts_with("TEMPER")) %>%
  pivot_longer(starts_with("TEMPER")) %>%
  mutate_at(vars(name), ~case_when(
    str_ends(., "NIMA") ~ "Temperatura mínima",
    str_ends(., "IA") ~ "Temperatura média",
    str_ends(., "XIMA") ~ "Temperatura máxima")) %>% 
  ggplot(aes(x=Data)) +
  scale_x_date(label=function(x) str_sub(str_to_title(strftime(x, "%b")),1,1),
               breaks="month", name="Mês") +
  scale_y_continuous(name="Precipitação (mm)",
                     sec.axis = sec_axis(~./2, name="Temperatura (°C)")) +
  geom_bar(stat="unique", aes(y=PRECIPITACAO), fill="#4292c6") +
  geom_line(aes(y=value*2, color=name)) +
  scale_color_manual(values=c("#cb181d", "#000000", "#08306b")) +
  theme_minimal() +
  theme(legend.position = "bottom",
        legend.title = element_blank())

```

# Exercício 3

- \icon Encontrar o conjunto de dados dos Cursos Ativos da Graduação da UFSCar
(https://dados.gov.br/dados/conjuntos-dados/)
- \icon Processar os dados
- \icon Obter a soma de vagas para cada uma das duas modalidades

```{r,message=F,warning=F}

dados_ufscar <- read_csv("https://dados.ufscar.br/dataset/b00bb4d5-37ad-42e3-b726-30c06a448f3f/resource/f6f03301-42c9-4d23-80c3-75b1582a8020/download/cursos-presencial-graduacao.csv")

aggregate(dados_ufscar$Vagas, list(Modalidade=dados_ufscar$Modalidade), sum)
```

- \icon Fazer um gráfico, baseando-se no gráfico a seguir:

```{r, fig.height=3}

dados_ufscar %>%
  mutate_at(vars(Turno), factor, levels=c("Matutino", "Integral", "Noturno")) %>% 
  group_by(Turno, Modalidade, Campus) %>%
  filter(Modalidade != "EAD") %>% 
  summarise_at(vars(Vagas), sum) %>%
  ggplot(aes(x=Turno, y=Vagas)) +
  facet_wrap(~Campus) +
  geom_col(aes(fill=Turno), show.legend=F, color="grey25") +
  geom_hline(linetype="dashed",
             aes(yintercept=1405, color="Vagas para modalidade EAD")) +
  scale_color_manual(values="red") +
  scale_fill_manual(values=c("orange", "yellow", "darkblue")) +
  theme_bw() +
  theme(legend.position="bottom",
        legend.title=element_blank())

```

# Exercício 4

Fazer um gráfico de dispersão, como o do exemplo:

```{r, warning=F, message=F, fig.height=6}

iris %>%
  pivot_longer(-Species) %>%
  separate(name, c("Parte da flor", "Medida")) %>% 
  pivot_wider(id_cols=c(Species,`Parte da flor`), names_from=Medida) %>%
  unnest_longer(c(Length, Width)) %>% 
  ggplot(aes(x=Length, y=Width, col=`Parte da flor`)) +
  geom_point(aes(shape=Species)) +
  geom_smooth(aes(linetype=Species), method="lm", se=F, formula=y~x) +
  theme_bw() +
  scale_linetype_manual(values=c("solid", "dotted", "dashed")) +
  scale_color_manual(values=c("#E41A1C", "#377EB8"))

```
